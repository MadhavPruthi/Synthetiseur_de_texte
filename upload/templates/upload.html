{% load static %}

<!DOCTYPE html>
<html lang="en">

<head>
    <title>Synthetiseur de Texte</title>
    <link rel="icon" href="{% static 'icon.png' %}">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
          integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">

    <!-- JS, Popper.js, and jQuery -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
            integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj"
            crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
            integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN"
            crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"
            integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV"
            crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="{% static 'style.css' %}">
    <script
            src="https://code.jquery.com/jquery-3.5.1.js"
            integrity="sha256-QWo7LDvxbWT2tbbQ97B53yJnYU3WhH/C8ycbRAkjPDc="
            crossorigin="anonymous"></script>
    <script>
        $(document).ready(function () {
            $('input[type="file"]').change(function (e) {
                var fileName = e.target.files[0].name;
                $('label').text(fileName);
            });
        });
    </script>


</head>
<body>
<nav class="navbar navbar-dark bg-dark">
    <a class="navbar-brand" href="#">
        Synthetiseur de Texte
    </a>
</nav>

<div class="container" id="description">
    <div class="row">
        <div class="col-6 mx-auto col-md-4 order-md-2">
            <img height="200px" src="{% static 'homepage.png' %}">
        </div>
        <div class="col-md-8 order-md-1 text-center text-md-left pr-md-5">
            <h1 class="mb-3">Get Your Lecture Summary Easily</h1>
            <p>
                Synthetiseur de Texte provides you an easy way to convert your lecture video/audio to a summary so it is
                easier for you to refer to it later.
            </p>

        </div>
    </div>

</div>


<div class="container" id="middle-section">

    <nav>
        <div class="nav nav-tabs" id="nav-tab" role="tablist">
            <a class="nav-item nav-link active" id="nav-home-tab" data-toggle="tab" href="#nav-home" role="tab"
               aria-controls="nav-home" aria-selected="true">Upload Media/Lecture</a>
            <a class="nav-item nav-link" id="nav-profile-tab" data-toggle="tab" href="#nav-summary" role="tab"
               aria-controls="nav-profile" aria-selected="false">Generate Summary/Questions</a>
        </div>
    </nav>
    <div class="tab-content" id="nav-tabContent">
        <div class="tab-pane fade show active" id="nav-home" role="tabpanel" aria-labelledby="nav-home-tab">
            {% if all_files %}
                <ul class="list-group">
                    {% for media in all_files %}
                        <li class="list-group-item">
                        <a href="{{ media.file.url }}" target="_blank">{{ media.file.name }}</a> | {{ media.unique_id }}
                    {% endfor %}
                </ul>
            {% else %}
                <h3 style="padding: 6px 0 6px 0">You don't have any lectures yet!</h3>
            {% endif %}

            <div class="card text-white bg-info" style="margin: 25px">
                <div class="card-header">Constraints regarding file upload</div>
                <div class="card-body">
                    <p class="card-text">File should be in <span class="text-warning"><b>MP4 or WAV</b></span> format
                        and
                        Size must be less than
                        <span class="text-warning"><b>4 MB</b></span></p>
                </div>
            </div>
            <form method="post" action="" enctype="multipart/form-data" name="file_upload"
                  onsubmit="return fileSizeCheck()">
                <div class="form-group">
                    {% csrf_token %}
                    {{ form }}
                </div>
                <button type="submit" class="btn btn-success">Upload File!</button>

                <div class="progress" id="progress_bar">
                    <div class="progress-bar progress-bar-striped progress-bar-animated " role="progressbar"
                         aria-valuenow="75" aria-valuemin="0" aria-valuemax="100" style="width: 75%"></div>
                </div>

            </form>
            {% if unique_id %}
                <div>Your Unique ID is <span class="font-weight-bold text-success"
                                             id="unique_id_identifier">{{ unique_id }}</span>
                    <button class="btn" onclick="copyFunction()"><i class="fa fa-clone" title="Copy to clipboard"></i>
                    </button>
                </div>
            {% endif %}
        </div>
        <div class="tab-pane fade" id="nav-summary" role="tabpanel" aria-labelledby="nav-profile-tab">
            <label for="unique_id">Enter your ID associated with your video: </label>
            <input type="text" id="unique_id" name="unique_id" required>
            <button type="submit" id="target" class="btn btn-primary">Summarize and Generate Practice Questions</button>
            <br>
            <div id='loader' style='display: none;'>
                <img src="{% static 'loading.gif' %}" width='32px' height='32px' alt="loader">
            </div>
            <div class="text-danger" id="error_message"></div>
            <div id="generated_summary">Summary will be shown here!</div>
            <div id="generated_questions"></div>
        </div>
    </div>
</div>


<footer class="page-footer font-small blue pt-4">
    <div class="container-fluid text-center text-md-left">
        <div class="row">
            <div class="col-md-6 mt-md-0 mt-3">
                <h5 class="text-uppercase">Synthetiseur de Texte</h5>
                <!--
                TODO: To add something about our project
                -->
                <p>Please Add some content here chappe</p>
            </div>
            <hr class="clearfix w-100 d-md-none pb-3">
        </div>
    </div>
    <div class="footer-copyright text-center py-3">Â© 2020 Copyright:
        <a href="#">Team Pero_gamers :)</a>
    </div>
</footer>

<script>
    function fileSizeCheck() {
        let oFile = document.forms["file_upload"]["file"].files[0];
        if (oFile.size > 4194304) {
            alert("File size must under 4MB! (Currently: " + (oFile.size / 1024 / 1024).toFixed(2) + " MB)");
            return false;
        }
        return true;
    }

    function copyFunction() {

        let $temp = $("<input>");
        $("body").append($temp);
        $temp.val($("#unique_id_identifier").text()).select();
        document.execCommand("copy");
        $temp.remove();

        alert("ID Copied!");
    }

    function getCookie(name) {
        var cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = jQuery.trim(cookies[i]);
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    $.fn.toggleText = function (t1, t2) {
        if (this.text() === t1) this.text(t2);
        else this.text(t1);
        return this;
    };

    function toggleSummary() {
        let element = $("#generated_summary");

        $.trim(element.html()) === summ_on ? element.html(summ_off) : element.html(summ_on);
    }

    let summ_on, summ_off;

    $(document).ready(function () {
        $("#target").click(function (e) {
            const csrftoken = getCookie('csrftoken');
            const input_data = {
                "unique_id": $("#unique_id").val(),
            };
            $.ajax({
                type: "POST",
                url: "/dev/run",
                data: input_data,
                beforeSend: function (xhr, settings) {
                    xhr.setRequestHeader("X-CSRFToken", csrftoken);
                    $("#loader").show();
                    $("#error_message").html("");
                    $("#generated_summary").html("");
                    $("#generated_questions").html("");
                },

                success: function (data) {
                    if (data["has_error"] === true) {
                        $("#error_message").html(data["error"]);
                    } else {
                        let IconHTML_on = "<div onclick=\"toggleSummary()\"><i class=\"fa fa-toggle-on\" aria-hidden=\"true\"></i></div>";
                        let IconHTML_off = "<div onclick=\"toggleSummary()\"><i class=\"fa fa-toggle-off\" aria-hidden=\"true\"></i></div>";

                        summ_on = "<h3>Summary " + IconHTML_on + "</h3><span class=\"text-success\">Compression Ratio: <b>" +
                            data["compression_ratio"] + "%</b></span><blockquote>" + data["summary"] + "</blockquote>";

                        summ_off = "<h3>Original Text " + IconHTML_off + "</h3><span class=\"text-success\">Compression Ratio: <b>" +
                            data["compression_ratio"] + "%</b></span><blockquote>" + data["original_text"] + "</blockquote>";

                        $("#generated_summary").html(summ_on);

                        let arr = JSON.parse(data["question_list"]);
                        let questions = "";
                        questions += "<ul>";
                        let index;
                        for (index = 0; index < arr.length; index++) {
                            questions += "<li>" + arr[index] + "</li>";
                        }
                        questions += "</ul>";
                        $("#generated_questions").html("<h3>Question List</h3><blockquote>" + questions + "</blockquote>")
                    }

                },
                complete: function () {
                    $("#loader").hide();
                },
                error: function (jqXHR, exception) {
                    let msg = "";
                    if (jqXHR.status === 0) {
                        msg = 'Not able to connect.\n Verify Network.';
                    } else if (jqXHR.status === 404) {
                        msg = 'Requested page not found. [404]';
                    } else if (jqXHR.status === 500) {
                        msg = 'Internal Server Error [500].';
                    } else if (exception === 'parsererror') {
                        msg = 'Requested JSON parse failed.';
                    } else if (exception === 'timeout') {
                        msg = 'Time out error.';
                    } else if (exception === 'abort') {
                        msg = 'Ajax request aborted.';
                    } else {
                        msg = 'Uncaught Error.\n' + jqXHR.responseText;
                    }
                    $("#error_message").html(msg);
                },
            });
        });
    });

</script>
</body>

</html>